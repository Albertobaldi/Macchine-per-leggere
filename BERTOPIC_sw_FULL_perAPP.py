import streamlit as st
from streamlit import session_state
import pandas as pd
import numpy as np
import base64
import warnings
warnings.filterwarnings("ignore")
import re
from tqdm import tqdm
import string
import nltk
import io
from io import StringIO
import string
from collections import Counter
from wordcloud import WordCloud
from sklearn.feature_extraction.text import TfidfVectorizer
import matplotlib.pyplot as plt
from bertopic import BERTopic
import itertools
from typing import List
import plotly.graph_objects as go
from plotly.subplots import make_subplots

def _max_width_():
    max_width_str = f"max-width: 1400px;"
    st.markdown(
        f"""
    <style>
    .reportview-container .main .block-container{{
        {max_width_str}
    }}
    </style>    
    """,
        unsafe_allow_html=True,
    )
st.set_page_config(
    page_title="BERTopic",
    page_icon="üéà",
) 
st.title("BERTopic")
st.subheader("Topic modeling e analisi dei temi su un corpus testuale")
from sklearn.feature_extraction.text import CountVectorizer

if 'final_stopwords' not in st.session_state:
	st.session_state.final_stopwords = False

final_stopwords_list = st.sidebar.text_input("Inserisci una lista di stopwords, separate da una virgola (es. \"parola1, parola2, parola3\")", "")
        
vectorizer_model = CountVectorizer(stop_words=["ai", "agli", "all", "agl", "alla", "alle", "con", "col", "coi", "da", "dal", "dallo", "dai", "dagli", "dall", "dagl", "dalla", "dalle", "di", "del", "dello", "dei", "degli", "dell", "degl", "della", "delle", "in", "nel", "nello", "nei", "negli", "nell", "negl", "nella", "nelle", "su", "sul", "sullo", "sui", "sugli", "sull", "sugl", "sulla", "sulle", "per", "tra", "contro", "io", "tu", "lui", "lei", "noi", "voi", "loro", "mio", "mia", "miei", "mie", "tuo", "tua", "tuoi", "tue", "suo", "sua", "suoi", "sue", "nostro", "nostra", "nostri", "nostre", "vostro", "vostra", "vostri", "vostre", "mi", "ti", "ci", "vi", "lo", "la", "li", "le", "gli", "ne", "il", "un", "uno", "una", "ma", "ed", "se", "perch√©", "anche", "come", "dov", "dove", "che", "chi", "cui", "non", "pi√π", "quale", "quanto", "quanti", "quanta", "quante", "quello", "quelli", "quella", "quelle", "questo", "questi", "questa", "queste", "si", "tutto", "tutti", "a", "c", "e", "i", "l", "o", "ho", "hai", "ha", "abbiamo", "avete", "hanno", "abbia", "abbiate", "abbiano", "avr√≤", "avrai", "avr√†", "avremo", "avrete", "avranno", "avrei", "avresti", "avrebbe", "avremmo", "avreste", "avrebbero", "avevo", "avevi", "aveva", "avevamo", "avevate", "avevano", "ebbi", "avesti", "ebbe", "avemmo", "aveste", "ebbero", "avessi", "avesse", "avessimo", "avessero", "avendo", "avuto", "avuta", "avuti", "avute", "sono", "sei", "√®", "siamo", "siete", "sia", "siate", "siano", "sar√≤", "sarai", "sar√†", "saremo", "sarete", "saranno", "sarei", "saresti", "sarebbe", "saremmo", "sareste", "sarebbero", "ero", "eri", "era", "eravamo", "eravate", "erano", "fui", "fosti", "fu", "fummo", "foste", "furono", "fossi", "fosse", "fossimo", "fossero", "essendo", "faccio", "fai", "facciamo", "fanno", "faccia", "facciate", "facciano", "far√≤", "farai", "far√†", "faremo", "farete", "faranno", "farei", "faresti", "farebbe", "faremmo", "fareste", "farebbero", "facevo", "facevi", "faceva", "facevamo", "facevate", "facevano", "feci", "facesti", "fece", "facemmo", "faceste", "fecero", "facessi", "facesse", "facessimo", "facessero", "facendo", "sto", "stai", "sta", "stiamo", "stanno", "stia", "stiate", "stiano", "star√≤", "starai", "star√†", "staremo", "starete", "staranno", "starei", "staresti", "starebbe", "staremmo", "stareste", "starebbero", "stavo", "stavi", "stava", "stavamo", "stavate", "stavano", "stetti", "stesti", "stette", "stemmo", "steste", "stettero", "stessi", "stesse", "stessimo", "stessero", "stando", "abbastanza", "accidenti", "adesso", "affinch√©", "ahime", "ahim√®", "alcuna", "alcuni", "alcuno", "allora", "altre", "altri", "altrimenti", "altro", "altrove", "altrui", "ancora", "anni", "anno", "ansa", "anticipo", "assai", "attesa", "attraverso", "avanti", "avente", "aver", "avere", "averlo", "basta", "ben", "bene", "benissimo", "brava", "bravo", "buono", "caso", "cento", "certa", "certe", "certi", "certo", "chicchessia", "chiunque", "ciascuna", "ciascuno", "cima", "cinque", "cio", "cioe", "cio√®", "circa", "citta", "citt√†", "ci√≤", "co", "codesta", "codesti", "codesto", "cogli", "colei", "coll", "coloro", "colui", "cominci", "comprare", "comunque", "concernente", "conclusione", "consecutivi", "consecutivo", "consiglio", "cortesia", "cos", "cosa", "cosi", "cos√¨", "d", "dappertutto", "davanti", "dentro", "detto", "deve", "devo", "dice", "dietro", "dire", "dirimpetto", "diventa", "diventare", "diventato", "dopo", "doppio", "dovra", "dovr√†", "dovunque", "due", "dunque", "durante", "ecc", "ecco", "effettivamente", "egli", "ella", "entrambi", "eppure", "esempio", "esse", "esser", "essere", "essi", "ex", "fa", "fare", "fatto", "favore", "fin", "finalmente", "finche", "fine", "fino", "forse", "forza", "fra", "frattempo", "fuori", "futuro", "generale", "gente", "gia", "giacche", "giorni", "giorno", "giu", "gi√†", "gliela", "gliele", "glieli", "glielo", "gliene", "grande", "grazie", "gruppo", "haha", "ie", "ieri", "improvviso", "inc", "indietro", "infatti", "inoltre", "insieme", "intanto", "intorno", "invece", "lasciato", "lato", "lontano", "lungo", "luogo", "l√†", "macche", "magari", "maggior", "mai", "male", "malgrado", "malissimo", "me", "medesimo", "mediante", "meglio", "meno", "mentre", "mesi", "mezzo", "mila", "miliardi", "milioni", "minimi", "modo", "molta", "molti", "moltissimo", "molto", "momento", "mondo", "nemmeno", "neppure", "nessun", "nessuna", "nessuno", "niente", "no", "nome", "nondimeno", "nonostante", "nonsia", "novanta", "nove", "nulla", "nuovi", "nuovo", "od", "oggi", "ogni", "ognuna", "ognuno", "oltre", "oppure", "ora", "ore", "osi", "ossia", "ottanta", "otto", "paese", "parecchi", "parecchie", "parecchio", "parte", "partendo", "peccato", "peggio", "perche", "perch√®", "percio", "perci√≤", "perfino", "pero", "persino", "persone", "per√≤", "piedi", "pieno", "piglia", "piu", "piuttosto", "po", "pochissimo", "poco", "poi", "poiche", "possa", "possedere", "posteriore", "posto", "potrebbe", "preferibilmente", "presa", "press", "prima", "primo", "principalmente", "probabilmente", "promesso", "proprio", "puo", "pure", "purtroppo", "pu√≤", "qua", "qualche", "qualcosa", "qualcuna", "qualcuno", "quali", "qualunque", "quando", "quantunque", "quarto", "quasi", "quattro", "quel", "quest", "qui", "quindi", "quinto", "realmente", "recente", "recentemente", "registrazione", "relativo", "riecco", "rispetto", "salvo", "sara", "scola", "scopo", "scorso", "secondo", "seguente", "seguito", "sembra", "sembrare", "sembrato", "sembrava", "sembri", "sempre", "senza", "sette", "sig", "solito", "solo", "soltanto", "sopra", "soprattutto", "sotto", "spesso", "stata", "state", "stati", "stato", "stessa", "stesso", "subito", "successivamente", "successivo", "tale", "tali", "talvolta", "tanto", "te", "tempo", "terzo", "th", "titolo", "tranne", "tre", "trenta", "triplo", "troppo", "trovato", "tutta", "tuttavia", "tutte", "uguali", "ulteriore", "ultimo", "uomo", "va", "vai", "vale", "vari", "varia", "varie", "vario", "verso", "vicino", "visto", "vita", "volta", "volte", "√®", "Ad", "Al", "Allo", "Ai", "Agli", "All", "Agl", "Alla", "Alle", "Con", "Col", "Coi", "Da", "Dal", "Dallo", "Dai", "Dagli", "Dall", "Dagl", "Dalla", "Dalle", "Di", "Del", "Dello", "Dei", "Degli", "Dell", "Degl", "Della", "Delle", "In", "Nel", "Nello", "Nei", "Negli", "Nell", "Negl", "Nella", "Nelle", "Su", "Sul", "Sullo", "Sui", "Sugli", "Sull", "Sugl", "Sulla", "Sulle", "Per", "Tra", "Contro", "Io", "Tu", "Lui", "Lei", "Noi", "Voi", "Loro", "Mio", "Mia", "Miei", "Mie", "Tuo", "Tua", "Tuoi", "Tue", "Suo", "Sua", "Suoi", "Sue", "Nostro", "Nostra", "Nostri", "Nostre", "Vostro", "Vostra", "Vostri", "Vostre", "Mi", "Ti", "Ci", "Vi", "Lo", "La", "Li", "Le", "Gli", "Ne", "Il", "Un", "Uno", "Una", "Ma", "Ed", "Se", "Perch√©", "Anche", "Come", "Dov", "Dove", "Che", "Chi", "Cui", "Non", "Pi√π", "Quale", "Quanto", "Quanti", "Quanta", "Quante", "Quello", "Quelli", "Quella", "Quelle", "Questo", "Questi", "Questa", "Queste", "Si", "Tutto", "Tutti", "A", "C", "E", "I", "L", "O", "Ho", "Hai", "Ha", "Abbiamo", "Avete", "Hanno", "Abbia", "Abbiate", "Abbiano", "Avr√≤", "Avrai", "Avr√†", "Avremo", "Avrete", "Avranno", "Avrei", "Avresti", "Avrebbe", "Avremmo", "Avreste", "Avrebbero", "Avevo", "Avevi", "Aveva", "Avevamo", "Avevate", "Avevano", "Ebbi", "Avesti", "Ebbe", "Avemmo", "Aveste", "Ebbero", "Avessi", "Avesse", "Avessimo", "Avessero", "Avendo", "Avuto", "Avuta", "Avuti", "Avute", "Sono", "Sei", "√à", "Siamo", "Siete", "Sia", "Siate", "Siano", "Sar√≤", "Sarai", "Sar√†", "Saremo", "Sarete", "Saranno", "Sarei", "Saresti", "Sarebbe", "Saremmo", "Sareste", "Sarebbero", "Ero", "Eri", "Era", "Eravamo", "Eravate", "Erano", "Fui", "Fosti", "Fu", "Fummo", "Foste", "Furono", "Fossi", "Fosse", "Fossimo", "Fossero", "Essendo", "Faccio", "Fai", "Facciamo", "Fanno", "Faccia", "Facciate", "Facciano", "Far√≤", "Farai", "Far√†", "Faremo", "Farete", "Faranno", "Farei", "Faresti", "Farebbe", "Faremmo", "Fareste", "Farebbero", "Facevo", "Facevi", "Faceva", "Facevamo", "Facevate", "Facevano", "Feci", "Facesti", "Fece", "Facemmo", "Faceste", "Fecero", "Facessi", "Facesse", "Facessimo", "Facessero", "Facendo", "Sto", "Stai", "Sta", "Stiamo", "Stanno", "Stia", "Stiate", "Stiano", "Star√≤", "Starai", "Star√†", "Staremo", "Starete", "Staranno", "Starei", "Staresti", "Starebbe", "Staremmo", "Stareste", "Starebbero", "Stavo", "Stavi", "Stava", "Stavamo", "Stavate", "Stavano", "Stetti", "Stesti", "Stette", "Stemmo", "Steste", "Stettero", "Stessi", "Stesse", "Stessimo", "Stessero", "Stando", "Abbastanza", "Accidenti", "Adesso", "Affinch√©", "Ahime", "Ahim√®", "Alcuna", "Alcuni", "Alcuno", "Allora", "Altre", "Altri", "Altrimenti", "Altro", "Altrove", "Altrui", "Ancora", "Anni", "Anno", "Ansa", "Anticipo", "Assai", "Attesa", "Attraverso", "Avanti", "Avente", "Aver", "Avere", "Averlo", "Basta", "Ben", "Bene", "Benissimo", "Brava", "Bravo", "Buono", "Caso", "Cento", "Certa", "Certe", "Certi", "Certo", "Chicchessia", "Chiunque", "Ciascuna", "Ciascuno", "Cima", "Cinque", "Cio", "Cioe", "Cio√®", "Circa", "Citta", "Citt√†", "Ci√≤", "Co", "Codesta", "Codesti", "Codesto", "Cogli", "Colei", "Coll", "Coloro", "Colui", "Cominci", "Comprare", "Comunque", "Concernente", "Conclusione", "Consecutivi", "Consecutivo", "Consiglio", "Cortesia", "Cos", "Cosa", "Cosi", "Cos√¨", "D", "Dappertutto", "Davanti", "Dentro", "Detto", "Deve", "Devo", "Dice", "Dietro", "Dire", "Dirimpetto", "Diventa", "Diventare", "Diventato", "Dopo", "Doppio", "Dovra", "Dovr√†", "Dovunque", "Due", "Dunque", "Durante", "Ecc", "Ecco", "Effettivamente", "Egli", "Ella", "Entrambi", "Eppure", "Esempio", "Esse", "Esser", "Essere", "Essi", "Ex", "Fa", "Fare", "Fatto", "Favore", "Fin", "Finalmente", "Finche", "Fine", "Fino", "Forse", "Forza", "Fra", "Frattempo", "Fuori", "Futuro", "Generale", "Gente", "Gia", "Giacche", "Giorni", "Giorno", "Giu", "Gi√†", "Gliela", "Gliele", "Glieli", "Glielo", "Gliene", "Grande", "Grazie", "Gruppo", "Haha", "Ie", "Ieri", "Improvviso", "Inc", "Indietro", "Infatti", "Inoltre", "Insieme", "Intanto", "Intorno", "Invece", "Lasciato", "Lato", "Lontano", "Lungo", "Luogo", "L√†", "Macche", "Magari", "Maggior", "Mai", "Male", "Malgrado", "Malissimo", "Me", "Medesimo", "Mediante", "Meglio", "Meno", "Mentre", "Mesi", "Mezzo", "Mila", "Miliardi", "Milioni", "Minimi", "Modo", "Molta", "Molti", "Moltissimo", "Molto", "Momento", "Mondo", "Nemmeno", "Neppure", "Nessun", "Nessuna", "Nessuno", "Niente", "No", "Nome", "Nondimeno", "Nonostante", "Nonsia", "Novanta", "Nove", "Nulla", "Nuovi", "Nuovo", "Od", "Oggi", "Ogni", "Ognuna", "Ognuno", "Oltre", "Oppure", "Ora", "Ore", "Osi", "Ossia", "Ottanta", "Otto", "Paese", "Parecchi", "Parecchie", "Parecchio", "Parte", "Partendo", "Peccato", "Peggio", "Perche", "Perch√®", "Percio", "Perci√≤", "Perfino", "Pero", "Persino", "Persone", "Per√≤", "Piedi", "Pieno", "Piglia", "Piu", "Piuttosto", "Po", "Pochissimo", "Poco", "Poi", "Poiche", "Possa", "Possedere", "Posteriore", "Posto", "Potrebbe", "Preferibilmente", "Presa", "Press", "Prima", "Primo", "Principalmente", "Probabilmente", "Promesso", "Proprio", "Puo", "Pure", "Purtroppo", "Pu√≤", "Qua", "Qualche", "Qualcosa", "Qualcuna", "Qualcuno", "Quali", "Qualunque", "Quando", "Quantunque", "Quarto", "Quasi", "Quattro", "Quel", "Quest", "Qui", "Quindi", "Quinto", "Realmente", "Recente", "Recentemente", "Registrazione", "Relativo", "Riecco", "Rispetto", "Salvo", "Sara", "Scola", "Scopo", "Scorso", "Secondo", "Seguente", "Seguito", "Sembra", "Sembrare", "Sembrato", "Sembrava", "Sembri", "Sempre", "Senza", "Sette", "Sig", "Solito", "Solo", "Soltanto", "Sopra", "Soprattutto", "Sotto", "Spesso", "Stata", "State", "Stati", "Stato", "Stessa", "Stesso", "Subito", "Successivamente", "Successivo", "Tale", "Tali", "Talvolta", "Tanto", "Te", "Tempo", "Terzo", "Th", "Titolo", "Tranne", "Tre", "Trenta", "Triplo", "Troppo", "Trovato", "Tutta", "Tuttavia", "Tutte", "Uguali", "Ulteriore", "Ultimo", "Uomo", "Va", "Vai", "Vale", "Vari", "Varia", "Varie", "Vario", "Verso", "Vicino", "Visto", "Vita", "Volta", "Volte"])
            
uploaded_file = st.sidebar.file_uploader("Scegli un file di testo")
st.sidebar.caption('Verifica che il file sia privo di formattazione. Si raccomanda di convertire ogni fine di paragrafo in interruzione di linea (\\n): cos√¨ facendo, l‚Äôalgoritmo potr√† suddividere il testo in paragrafi')
st.sidebar.markdown("""---""")
if uploaded_file is not None:
    stringio = StringIO(uploaded_file.getvalue().decode("utf-8"))
    file = stringio.read().split('\n')
if st.button('Processa i dati'):
    st.write("Il vostro file √® in elaborazione. Il tempo impiegato nell‚Äôanalisi dei topic pu√≤ variare a seconda delle dimensioni del file di testo.")
    topic_model = BERTopic(language="multilingual", calculate_probabilities=True, verbose=True, vectorizer_model=vectorizer_model)
    st.session_state.topic_model = True
    topics, probs = topic_model.fit_transform(file)
    freq = topic_model.get_topic_info(); freq.head(10)
    info = topic_model.get_topic_info()
    top = topic_model.visualize_barchart(top_n_topics=10)
    distribution = topic_model.visualize_distribution(probs[100], min_probability=0.0005)
    st.write(info)
    st.plotly_chart(top, use_container_width=True)
    st.plotly_chart(distribution, use_container_width=True)
    
